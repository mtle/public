# How to set up unbound

[how-to-set-up-local-dns-with-unbound-on-debian](https://www.howtoforge.com/how-to-set-up-local-dns-with-unbound-on-debian/)<br/>
[how-to-set-up-local-dns-with-unbound-on-rocky-linux-9](https://www.howtoforge.com/how-to-set-up-local-dns-with-unbound-on-rocky-linux-9/)<br/>

##  Install unbound
```
# dnf install -y unbound
# wget https://www.internic.net/domain/named.root -O /var/lib/unbound/root.hints
# chown unbound:unbound /var/lib/unbound/root.hints
```

##  Config files
Copy unbound.conf to /et/unbound/

## Update root.hints
```
# curl --output /var/lib/unbound/root.hints  https://www.internic.net/domain/named.cache
```
OR
```
# curl --output /etc/unbound/root.hints https://www.internic.net/domain/named.cache
```

##  Local DNS server
Set nameserver to the loopback addresses ::1 and 127.0.0.1 in /etc/resolv.conf:
```
# cat /etc/resolv.conf
nameserver ::1
nameserver 127.0.0.1
options trust-ad
```

## Create private keys and certificates for remotely managing the unbound service:
```
# systemctl restart unbound-keygen
```

##  Check config file for errors
```
# unbound-control-setup
# unbound-checkconf
# grep -v '#\|^$' -R /etc/unbound/unbound.conf*
```

## Test run
```
# unbound -vvv -c /etc/unbound/unbound.conf
# journalctl --boot 0 --unit unbound.service
# tail /run/unbound/unbound.log
```


##  FW rules
```
# firewall-cmd --add-service=dns --permanent
# firewall-cmd --reload
# firewall-cmd --list-all
```

###  Optional: Setting up Unbound Log via Rsyslog and Logrotate
#### Create a new config file '/etc/rsyslog.d/unbound.conf'
```
sudo nano /etc/rsyslog.d/unbound.conf
```

** Add the following lines to the file. With this, the Rsyslog will create a new log file '/var/log/unbound.log' for the '$programname' == 'unbound'.
```
# Log messages generated by unbound application 
if $programname == 'unbound' then /var/log/unbound.log
# stop processing it further
& stop
```

#### Create a new Logrottate config file '/etc/logrotate.d/unbound' using the below nano editor command.

```
sudo nano /etc/logrotate.d/unbound
```

** Add the following lines to the file. This will create log rotation for the Unbound log file '/var/log/unbound.log' on a daily basis.

```
/var/log/unbound.log {
  daily
  rotate 7
  missingok
  create 0640 root adm
  postrotate
    /usr/lib/rsyslog/rsyslog-rotate
  endscript
}
```

#### Restart both Rsyslog and Logrotate services and apply the changes to your system.

```
sudo systemctl restart rsyslog
sudo systemctl restart logrotate
```

##  Enable and start
```
# systemctl enable unbound
# systemctl start unbound
```
OR
```
# systemctl enable --now unbound
```

##  Testing Unbound DNS Server
```
$ ss -4 -alnp sport = :53
$ ss -4 -tulnp sport = :53
$ ss --ipv4 --tcp --udp --listening --numeric --processes sport = :53
$ journalctl -u unbound -f
# journalctl --boot 0 --unit unbound.service
$ dig @127.0.0.1 -p 53 google.com
$ dig @127.0.0.1 -p 53 github.com
$ dig @127.0.0.1 -p 53 duckduckgo.com
$ dig fw.adm.mple +short
$ dig -x 172.19.55.5 +short
```

- From another machine
```
dig @172.19.55.53 -p 5335 github.com +short
```

##   AdguardHome
```
# curl -s -S -L https://raw.githubusercontent.com/AdguardTeam/AdGuardHome/master/scripts/install.sh | sh -s -- -v
```
or
```
# fetch -o - https://raw.githubusercontent.com/AdguardTeam/AdGuardHome/master/scripts/install.sh | sh -s -- -v
```
or
```
# wget --no-verbose -O - https://raw.githubusercontent.com/AdguardTeam/AdGuardHome/master/scripts/install.sh | sh -s -- -v
# cd /opt/AdguardHome
# ./AdGuardHome -s install
```

```
## All zones:
sudo firewall-cmd --add-service={dns,http,https} --permanent

## zone specific:
sudo firewall-cmd --zone=public --add-service={dns,http,https} --permanent
sudo firewall-cmd --zone=public --add-port=3000/tcp --permanent
sudo firewall-cmd --reload
```
